esphome:
  name: wekker
  friendly_name: ${friendlyname}
  platformio_options:
    board_build.flash_mode: dio
  on_boot:
    - media_player.volume_set:
        id: slaapkamer_media_player
        volume: 20%

substitutions:
  friendlyname: "wekker"

external_components:
  - source:
      type: git
      url: https://github.com/gnumpi/esphome_audio
      ref: main
    components:
      - adf_pipeline
      - i2s_audio
    refresh: never

esp32:
  board:   esp32-s3-devkitc-1
  variant: esp32s3
  flash_size: 16MB
  framework:
    type:  esp-idf
    version: 4.4.8
    platform_version: 5.4.0
    sdkconfig_options:
      CONFIG_ESP32_S3_BOX_BOARD: "y"

psram:
  mode: octal
  speed: 80MHz

# Enable logging
logger:
  level: debug

# Enable Home Assistant API
api:
  encryption:
    key: "xxx"
  actions:
    - action: rtttl_play
      variables:
        song_str: string
      then:
        - rtttl.play:
            rtttl: !lambda 'return song_str;'
#      rtttl.play: 'Flintstones:d=4,o=5,b=200:g#,c#,8p,c#6,8a#,g#,c#,8p,g#,8f#,8f,8f,8f#,8g#,c#,d#,2f,2p,g#,c#,8p,c#6,8a#,g#,c#,8p,g#,8f#,8f,8f,8f#,8g#,c#,d#,2c#'


ota:
  - platform: esphome
    password: "xxx"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  domain: .lan

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Wekker Fallback Hotspot"
    password: "xxx"

captive_portal:

# AUX1 pin is GPIO8
# AUX2 pin is GPIO2

i2s_audio:
  - id: i2s_out
    i2s_lrclk_pin: GPIO9
    i2s_bclk_pin: GPIO10

adf_pipeline:
  - platform: i2s_audio
    type: audio_out
    id: adf_i2s_out
    i2s_audio_id: i2s_out
    i2s_dout_pin: GPIO11

media_player:
  - platform: adf_pipeline
    id: slaapkamer_media_player
    name: ${friendlyname}
    keep_pipeline_alive: false
    internal: false
    pipeline:
      - self
      - adf_i2s_out

i2c:
    sda: GPIO21
    scl: GPIO47
    scan: true

time:
  - platform: sntp
    id: sntp_time
    timezone: Europe/Brussels
    servers:
     - 0.be.pool.ntp.org
     - 1.be.pool.ntp.org
     - 2.be.pool.ntp.org

display:
  - platform: tm1637
    clk_pin: GPIO18
    dio_pin: GPIO17
    inverted: true
    update_interval: 2s
    intensity: 0
    id: temp_display
    lambda: |-
        it.set_intensity(id(display_intensity).state);
        it.printf(0, "%.0f~C",id(bedroom_temperature).state);

  - platform: tm1637
    clk_pin: GPIO15
    dio_pin: GPIO16
    update_interval: 2s
    intensity: 0
    id: time_display
    lambda: |-
        static int i = 0;
        i++;
        it.set_intensity(id(display_intensity).state);
        if ((i % 2) == 0)
          it.strftime("%H.%M", id(sntp_time).now());
        else
          it.strftime("%H%M", id(sntp_time).now());

number:
  - platform: template
    id: display_intensity
    name: "${friendlyname} Intensity (0-7)"
    icon: mdi:brightness-5
    optimistic: true
    initial_value: 0
    min_value: 0
    max_value: 7
    step: 1
    update_interval: 1000ms
    restore_value: true
    on_value:
      then:
        - component.update: temp_display
        - component.update: time_display

binary_sensor:
  - platform: gpio
    pin:
      number: GPIO4
      inverted: true
      mode:
        input: true
    name: "${friendlyname} Knop Links"
  - platform: gpio
    pin:
      number: GPIO5
      inverted: true
      mode:
        input: true
    name: "${friendlyname} Knop Midden"
#    on_press:
#      then:
#        - switch.toggle: slaapkamerdac
  - platform: gpio
    pin:
      number: GPIO6
      inverted: true
      mode:
        input: true
    name: "${friendlyname} Knop Rechts"
    id: knop_rechts
    on_multi_click:
    - timing:
        - ON for at most 0.7s
      then:
        - logger.log: "simple click"
        - light.toggle: bedroomleds
    - timing:
        - ON for at least 1s
      then:
        - logger.log: "LONG click"
        - while:
            condition:
              binary_sensor.is_on: knop_rechts
            then:
              - light.dim_relative:
                  id: bedroomleds
                  relative_brightness: 5%
                  transition_length: 0.2s
                  brightness_limits:
                      max_brightness: 100%
              - delay: 0.1s

sensor:
  - platform: internal_temperature
    name: "${friendlyname} Internal Temperature"
    entity_category: "diagnostic"
    update_interval: 5.0min
  - platform: uptime
    name: ${friendlyname} Uptime
    id: sys_uptime
    entity_category: "diagnostic"
    filters:
      - lambda: return x / 86400;
    unit_of_measurement: "d"
    update_interval: 5.0min
  - platform: wifi_signal # Reports the WiFi signal strength/RSSI in dB
    name: "${friendlyname} WiFi Signal dB"
    id: wifi_signal_db
    entity_category: "diagnostic"
    update_interval: 5.0min
  - platform: copy # Reports the WiFi signal strength in %
    source_id: wifi_signal_db
    name: "${friendlyname} WiFi Signal Percent"
    filters:
      - lambda: return min(max(2 * (x + 100.0), 0.0), 100.0);
    unit_of_measurement: "%"
    entity_category: "diagnostic"
    device_class: ""
  - platform: adc
    id: light_sensor
    name: ${friendlyname} light Sensor
    update_interval: 1s
    pin: GPIO1
    attenuation: auto
  - platform: bme680
    temperature:
      name: "${friendlyname} Temperature"
      id: bedroom_temperature
      oversampling: 16x
    pressure:
      name: "${friendlyname} Pressure"
    humidity:
      id: "bedroom_humidity"
      name: "${friendlyname} Humidity"
    gas_resistance:
      id: "bedroom_gas_resistance"
      name: "${friendlyname} Gas Resistance"
    address: 0x77
    update_interval: 60s
  - platform: template
    name: "${friendlyname} Air Quality"
    id: bedroom_iaq
    icon: "mdi:gauge"
    # calculation: comp_gas = log(R_gas[ohm]) + 0.04 log(Ohm)/%rh * hum[%rh]
    lambda: |-
      return log(id(bedroom_gas_resistance).state) + 0.04 *  id(bedroom_humidity).state;
    state_class: "measurement"

text_sensor:
  - platform: template
    name: "${friendlyname} IAQ Classification"
    icon: "mdi:checkbox-marked-circle-outline"
    lambda: |-
      if (int(id(bedroom_iaq).state) <= 50) {
        return {"Excellent"};
      }
      else if (int(id(bedroom_iaq).state) <= 100) {
        return {"Good"};
      }
      else if (int(id(bedroom_iaq).state) <= 150) {
        return {"Lightly polluted"};
      }
      else if (int(id(bedroom_iaq).state) <= 200) {
        return {"Moderately polluted"};
      }
      else if (int(id(bedroom_iaq).state) <= 250) {
        return {"Heavily polluted"};
      }
      else if (int(id(bedroom_iaq).state) <= 350) {
        return {"Severely polluted"};
      }
      else if (int(id(bedroom_iaq).state) <= 500) {
        return {"Extremely polluted"};
      }
      else {
        return {"unknown"};
      }

interval:
- interval: 1s
  then:
    - lambda: |-
        float raw_value = id(light_sensor).state;
        int new_value = raw_value * 2;
        if (new_value != id(display_intensity).state) {
          id(display_intensity).state = new_value;
        }

output:
  - platform: ledc
    pin: GPIO7
    id: leds
    frequency: 4096
  - platform: ledc
    pin: GPIO13
    id: buzzer_out
    frequency: 4096
    max_power: 0.05

switch:
  - platform: gpio
    pin: GPIO12
    name: ${friendlyname} slaapkamerdac
    id: slaapkamerdac
    on_turn_on:
      - media_player.volume_set:
          id: slaapkamer_media_player
          volume: 20%

rtttl:
  output: buzzer_out
  id: my_rtttl

light:
  - platform: monochromatic
    name: "${friendlyname} Night Light"
    output: leds
    id: bedroomleds
